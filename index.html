<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>Ù‚Ø§Ù…ÙˆØ³ÙŠ</title>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script src="https://sdk.minepi.com/pi-sdk.js"></script>
<style>
body { font-family: Arial; text-align:center; padding:40px; background:#f5f5f5; }
input { padding:12px; width:80%; margin:10px; }
button { padding:12px 20px; margin:10px; border:none; border-radius:8px; font-size:16px; cursor:pointer; }
button.login { background:#4CAF50; color:white; }
button.pay { background:#673ab7; color:white; }
#result { font-size:22px; margin-top:20px; }
#user { margin-top:20px; font-weight:bold; }
</style>
</head>

<body>

<h2>ğŸ“˜ Ø§Ù„Ù‚Ø§Ù…ÙˆØ³</h2>

<button class="login" onclick="login()">Login Pi</button>
<br>
<button class="pay" onclick="pay()">Ø§Ø¯ÙØ¹ 1 Pi</button>
<br><br>

<input id="search" placeholder="Ø§ÙƒØªØ¨ ÙƒÙ„Ù…Ø©">
<button onclick="find()">Ø¨Ø­Ø«</button>
<h3 id="result"></h3>

<p id="user"></p>

<script>
/* ===== Firebase Configuration ===== */
const firebaseConfig = {
  apiKey: "AIzaSyASAhqVjPc-Hb4gyMBlgiuTYYulOtUCrso",
  authDomain: "cloudmall-dictionary.firebaseapp.com",
  projectId: "cloudmall-dictionary",
  storageBucket: "cloudmall-dictionary.firebasestorage.app",
  messagingSenderId: "244388055728",
  appId: "1:244388055728:web:824837bb2bb408a6848975"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ===== Pi SDK Initialization ===== */
Pi.init({ 
  version: "2.0", 
  sandbox: true,
  apiKey: "fkjojkkpa9wgrhwh969t1fhv34yjskkhdvynndcqr2xhyep44s7ydkmnsa7ndlui"
});

/* ===== LOGIN ===== */
async function login() {
  try {
    const scopes = ['username','payments'];
    const auth = await Pi.authenticate(scopes, onIncompletePaymentFound);
    currentUser = auth.user;
    document.getElementById("user").innerText =
      "Ù…Ø±Ø­Ø¨Ø§ " + auth.user.username;
  } catch (err) {
    alert("Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„");
    console.log(err);
  }
}

/* ===== PAYMENT ===== */
function pay() {
  if (!currentUser) {
    alert("Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø§ÙˆÙ„");
    return;
  }
  const paymentData = {
    amount: 1,
    memo: "Unlock dictionary",
    metadata: { item: "dictionary" }
  };
  const callbacks = {
  onReadyForServerApproval: async (paymentId) => {
    try {
      await fetch("/api/approve", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ paymentId })
      });
    } catch(e){
      console.log(e);
    }
  },

  onReadyForServerCompletion: (paymentId, txid) => {
    console.log(paymentId, txid);
  },

  onCancel: () => {
    alert("ØªÙ… Ø§Ù„ØºØ§Ø¡ Ø§Ù„Ø¯ÙØ¹");
  },

  onError: (error) => {
    console.log(error);
  }
};
  Pi.createPayment(paymentData, callbacks);
}

function onIncompletePaymentFound(payment) {
  console.log(payment);
}

/* ===== SEARCH DICTIONARY ===== */
async function find(){
  const word = document.getElementById("search").value.trim();
  if(!word){ 
    document.getElementById("result").innerText = "Ø§ÙƒØªØ¨ ÙƒÙ„Ù…Ø© Ø£ÙˆÙ„Ø§Ù‹"; 
    return; 
  }
  const snap = await db.collection("dictionary")
    .where("word","==", word)
    .get();
  if(snap.empty){
    document.getElementById("result").innerText = "Ø§Ù„ÙƒÙ„Ù…Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©";
  } else {
    snap.forEach(doc => {
      document.getElementById("result").innerText = doc.data().meaning;
    });
  }
}
</script>

</body>
</html>
